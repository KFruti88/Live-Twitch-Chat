# ==========================================
# WEREWOLF ALL-IN-ONE RELAY WORKFLOW
# Standard: Full Code Mandate - Kevin & Scott
# Updated: 2026-02-08 (Public Tunneling Fix)
# ==========================================

name: Werewolf All-In-One Relay

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  relay:
    runs-on: ubuntu-latest
    concurrency:
      group: relay-group
      cancel-in-progress: true
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Dependencies
        run: |
          npm install tmi.js tiktok-live-connector express axios discord.js cors localtunnel

      - name: Start Relay with Public Tunnel
        env:
          TWITCH_OAUTH: ${{ secrets.TWITCH_ACCESS_TOKEN }}
          TWITCH_CLIENT_ID: ${{ secrets.TWITCH_CLIENT_ID }}
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
          DISCORD_BOT_TOKEN: ${{ secrets.DISCORD_BOT_TOKEN }}
          TWITCH_BROADCASTER_ID: ${{ secrets.TWITCH_BROADCASTER_ID }}
          WP_RELAY_URL: ${{ secrets.WP_RELAY_URL }}
          PORT: 3000
        # This starts the bot AND opens a tunnel to the internet
        run: |
          node relay.js & 
          npx lt --port 3000 --subdomain werewolf-relay
