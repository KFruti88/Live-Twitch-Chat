name: Werewolf All-In-One Relay

on:
  push:
    branches: [ main ]
  schedule:
    # Restarts every 6 hours to keep the relay fresh
    - cron: '0 */6 * * *' 
  workflow_dispatch:      # Allows you to start it manually from the Actions tab

jobs:
  relay:
    runs-on: ubuntu-latest
    concurrency:
      group: relay-group
      cancel-in-progress: true # Prevents duplicate bots from running
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Dependencies
        # Must include discord.js for the !send command to work
        run: |
          npm install tmi.js tiktok-live-connector express axios discord.js

      - name: Start Relay Bot
        env:
          # Mapping your GitHub Secrets to the bot
          TWITCH_OAUTH: ${{ secrets.TWITCH_ACCESS_TOKEN }}
          TWITCH_CLIENT_ID: ${{ secrets.TWITCH_CLIENT_ID }}
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
          DISCORD_BOT_TOKEN: ${{ secrets.DISCORD_BOT_TOKEN }}
          # Keeping these for future expansion
          TWITCH_BROADCASTER_ID: ${{ secrets.TWITCH_BROADCASTER_ID }}
          WP_RELAY_URL: ${{ secrets.WP_RELAY_URL }}
          PORT: 3000
        # Runs for 6 hours (21600s) then restarts via the cron job
        run: timeout 21600s node relay.js
