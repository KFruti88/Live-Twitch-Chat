# ==========================================
# WEREWOLF ALL-IN-ONE RELAY WORKFLOW
# Standard: Full Code Mandate - Kevin & Scott
# Updated: 2026-02-07
# Targets: Twitch, TikTok, YouTube, Trovo, Discord
# ==========================================

name: Werewolf All-In-One Relay

on:
  push:
    branches: [ main ]
  schedule:
    # Restarts every 6 hours automatically to keep the connection fresh
    - cron: '0 */6 * * *' 
  workflow_dispatch:      # Allows manual start from the Actions tab

jobs:
  relay:
    runs-on: ubuntu-latest
    concurrency:
      group: relay-group
      cancel-in-progress: true # Prevents duplicate bots from running
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Dependencies
        # Ensuring all required libraries for TikTok, Twitch, and Discord are present
        run: |
          npm install tmi.js tiktok-live-connector express axios discord.js

      - name: Start Relay Bot
        env:
          # Mapping your GitHub Secrets to the bot for secure access
          TWITCH_OAUTH: ${{ secrets.TWITCH_ACCESS_TOKEN }}
          TWITCH_CLIENT_ID: ${{ secrets.TWITCH_CLIENT_ID }}
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
          DISCORD_BOT_TOKEN: ${{ secrets.DISCORD_BOT_TOKEN }}
          TWITCH_BROADCASTER_ID: ${{ secrets.TWITCH_BROADCASTER_ID }}
          WP_RELAY_URL: ${{ secrets.WP_RELAY_URL }}
          PORT: 3000
        # FIXED: Optimized timeout to 6 hours (21600s) to maximize runtime.
        # This executes relay.js which now contains the Heartbeat Engine to prevent early cancellation.
        run: timeout 21600s node relay.js
